name: Security Analysis (Alternative to CodeQL)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # ExÃ©cution quotidienne Ã  8h du matin
    - cron: '0 8 * * *'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive security audit
        run: npm run audit:security
        continue-on-error: true

      - name: Run npm security audit
        run: npm audit --audit-level=moderate --json > npm-audit-report.json
        continue-on-error: true

      - name: Run Semgrep security analysis
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/typescript
            p/vue
        continue-on-error: true

      - name: Run ESLint security rules
        run: npm run lint:security
        continue-on-error: true

      - name: Generate security report
        run: |
          echo "# ðŸ”’ Rapport d'Analyse de SÃ©curitÃ©" > security-analysis-report.md
          echo "" >> security-analysis-report.md
          echo "**Date:** $(date)" >> security-analysis-report.md
          echo "**Alternative Ã  CodeQL** - Analyse complÃ¨te sans GitHub Advanced Security" >> security-analysis-report.md
          echo "" >> security-analysis-report.md

          echo "## ðŸ› ï¸ Outils UtilisÃ©s" >> security-analysis-report.md
          echo "- **Security Audit** (npm run audit:security)" >> security-analysis-report.md
          echo "- **npm audit** (vulnÃ©rabilitÃ©s des dÃ©pendances)" >> security-analysis-report.md
          echo "- **Semgrep** (analyse de sÃ©curitÃ© avancÃ©e)" >> security-analysis-report.md
          echo "- **ESLint Security** (rÃ¨gles de sÃ©curitÃ©)" >> security-analysis-report.md
          echo "" >> security-analysis-report.md

          echo "## ðŸ“Š MÃ©triques" >> security-analysis-report.md
          echo "- **Fichiers analysÃ©s:** $(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | grep -v node_modules | wc -l)" >> security-analysis-report.md
          echo "- **Lignes de code:** $(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | grep -v node_modules | xargs wc -l | tail -1)" >> security-analysis-report.md
          echo "" >> security-analysis-report.md

          echo "## âœ… Avantages de cette Alternative" >> security-analysis-report.md
          echo "- âœ… **Gratuit** - Aucun coÃ»t GitHub Advanced Security" >> security-analysis-report.md
          echo "- âœ… **Complet** - Couvre les vulnÃ©rabilitÃ©s principales" >> security-analysis-report.md
          echo "- âœ… **IntÃ©grÃ©** - Workflows GitHub Actions" >> security-analysis-report.md
          echo "- âœ… **Personnalisable** - Scripts adaptÃ©s au projet" >> security-analysis-report.md
          echo "" >> security-analysis-report.md

          echo "## ðŸ“‹ RÃ©sultats" >> security-analysis-report.md
          echo "Consultez les logs ci-dessus pour les dÃ©tails de l'analyse." >> security-analysis-report.md
          echo "" >> security-analysis-report.md

          echo "## ðŸ”§ Commandes Locales" >> security-analysis-report.md
          echo "```bash" >> security-analysis-report.md
          echo "npm run audit:security    # Audit de sÃ©curitÃ© complet" >> security-analysis-report.md
          echo "npm run analyze:code      # Analyse de code locale" >> security-analysis-report.md
          echo "npm run lint:security     # ESLint avec rÃ¨gles de sÃ©curitÃ©" >> security-analysis-report.md
          echo "npm audit                 # Audit des dÃ©pendances" >> security-analysis-report.md
          echo "```" >> security-analysis-report.md

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-reports
          path: |
            security-analysis-report.md
            npm-audit-report.json
            security-audit-report.json

      - name: Comment PR with security findings
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              const fs = require('fs');
              const reportPath = 'security-analysis-report.md';
              
              if (fs.existsSync(reportPath)) {
                const report = fs.readFileSync(reportPath, 'utf8');
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: report
                });
                
                console.log('âœ… Rapport de sÃ©curitÃ© ajoutÃ© avec succÃ¨s');
              }
            } catch (error) {
              console.log('âš ï¸ Impossible d\'ajouter le rapport:', error.message);
            }

      - name: Create security summary
        run: |
          echo "## ðŸ”’ RÃ©sumÃ© de l'Analyse de SÃ©curitÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Alternative Ã  CodeQL** - Analyse complÃ¨te sans GitHub Advanced Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ Outils UtilisÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit (npm run audit:security)" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit (vulnÃ©rabilitÃ©s des dÃ©pendances)" >> $GITHUB_STEP_SUMMARY
          echo "- Semgrep (analyse de sÃ©curitÃ© avancÃ©e)" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint Security (rÃ¨gles de sÃ©curitÃ©)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š MÃ©triques" >> $GITHUB_STEP_SUMMARY
          echo "- Fichiers analysÃ©s: $(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | grep -v node_modules | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Lignes de code: $(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | grep -v node_modules | xargs wc -l | tail -1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Avantages" >> $GITHUB_STEP_SUMMARY
          echo "- **Gratuit** - Aucun coÃ»t GitHub Advanced Security" >> $GITHUB_STEP_SUMMARY
          echo "- **Complet** - Couvre les vulnÃ©rabilitÃ©s principales" >> $GITHUB_STEP_SUMMARY
          echo "- **IntÃ©grÃ©** - Workflows GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- **Personnalisable** - Scripts adaptÃ©s au projet" >> $GITHUB_STEP_SUMMARY


